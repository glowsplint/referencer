# GitHub Actions secrets — set in repo Settings → Secrets and variables → Actions
#
# CLOUDFLARE_API_TOKEN   — Cloudflare API token for deploying workers
#                          Provider: Cloudflare Dashboard → API Tokens
#                          Permissions: Workers Scripts (Edit), Account Settings (Read)
#
# CLOUDFLARE_ACCOUNT_ID  — Cloudflare account ID
#                          Provider: Cloudflare Dashboard → Overview → right sidebar

name: Deploy Workers

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "collab-server/**"

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Cloudflare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2

      - name: Install backend dependencies
        working-directory: backend
        run: bun install --frozen-lockfile

      - name: Install collab-server dependencies
        working-directory: collab-server
        run: bun install --frozen-lockfile

      - name: Deploy referencer-api
        uses: cloudflare/wrangler-action@v3
        with:
          workingDirectory: backend
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy referencer-collab
        uses: cloudflare/wrangler-action@v3
        with:
          workingDirectory: collab-server
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
